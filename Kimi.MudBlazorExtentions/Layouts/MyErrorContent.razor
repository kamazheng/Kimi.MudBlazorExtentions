@using Kimi.MudBlazorExtentions.Components
@using System.Text.Json
<MudContainer Class="pa-3">
    <MudStack Spacing="2" Class="ml-5 mt-3">
        <MudText Typo="Typo.h3" Color="Color.Error">ERROR OCCURRED</MudText>
        @if (CurrentException is not null )
        {
            <MudAlert Severity="Severity.Error" 
                style="word-wrap: break-word; word-break: break-all;">@(Truncate(DetailError,1000))</MudAlert>
            @if(readmore){
            <JsonViewer JsonData="@CurrentException?.Message" />
            }
        }
        <MudItem>
            @if (IfDialog != true)
            {
                <MudButton Variant="Variant.Filled" Color="Color.Success" Class="mr-3" OnClick="ClearError">Clear Error</MudButton>
            }
            <MudButton Variant="Variant.Filled" Color="Color.Warning" OnClick="ReadMore" Disabled="@readmore">Read More</MudButton>
        </MudItem>
    </MudStack>
</MudContainer>

@code {
    [Parameter]
    public Exception? CurrentException { get; set; }

    [Parameter]
    public ErrorBoundaryBase? errorBoundary { get; set; }

    [Parameter]
    public bool? IfDialog { get; set; } = false;

    [Inject]
    public NavigationManager? _navigation { get; set; }

    public string? DetailError => CurrentException?.ToString();
    public bool readmore { get; set; } = false;

    protected override void OnInitialized()
    {
        var errorBoundary = CurrentException;
        base.OnInitialized();
    }
    private void ReadMore(MouseEventArgs e)
    {
        readmore = true;
    }

    private void ClearError(MouseEventArgs e)
    {
        errorBoundary?.Recover();
        if (_navigation is not null)
        {
            _navigation.Refresh(forceReload: true);
        }
    }

    private static string Truncate(string text, int max = 160)
        => string.IsNullOrEmpty(text) ? (text ?? "") : (text.Length <= max ? text : text[..max] + " ...");

}

