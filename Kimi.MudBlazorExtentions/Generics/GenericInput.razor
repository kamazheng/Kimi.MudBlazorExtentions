@using Kimi.MudBlazorExtentions.Extensions
@using MudBlazor
@typeparam T
@inherits MudBaseInput<T>

@{
    var commonFieldAttributes = new Dictionary<string, object?>
    {
        { nameof(Label), Label },
        { nameof(HelperText), HelperText },
        { nameof(Disabled), Disabled },
        { nameof(ReadOnly), ReadOnly },
        { nameof(Required), Required },
        { nameof(Variant), Variant },
        { nameof(Margin), Margin },
        { nameof(Adornment), Adornment },
        { nameof(AdornmentIcon), AdornmentIcon },
        { nameof(FullWidth), FullWidth },
        { nameof(For), For },
        { nameof(Validation), Validation },
        { nameof(HelperTextOnFocus), HelperTextOnFocus }
    };

    // 安全处理 AdditionalAttributes 可能为 null 的情况
    var safeAdditionalAttributes = UserAttributes ?? new Dictionary<string, object?>();
    
    var mergedAttributes = safeAdditionalAttributes
        .Concat(commonFieldAttributes.Where(kvp => !safeAdditionalAttributes.ContainsKey(kvp.Key)))
        .ToDictionary(kvp => kvp.Key, kvp => kvp.Value);
}

@if (underlyingType == typeof(DateOnly))
{
    <MudTextField T="T"
        Value="GetSafeDTValue()"
        ValueChanged="OnValueChanged"
        InputType="InputType.Date"
        Converter="@GetTextConverterForT()"
        @attributes="mergedAttributes" />
}
else if (underlyingType == typeof(TimeOnly))
{
    <MudTextField T="T"
        Value="GetSafeDTValue()"
        ValueChanged="OnValueChanged"
        InputType="InputType.Time"
        Converter="@GetTextConverterForT()"
        @attributes="mergedAttributes" />
}
else if (underlyingType.IsEnum)
{
    <MudSelect T="T"
        Value="@Value"
        ValueChanged="OnValueChanged"
        @attributes="mergedAttributes">
        @foreach (T enumValue in Enum.GetValues(underlyingType))
        {
            var name = Enum.GetName(underlyingType, enumValue);
            var tip = XmlDocExtensions.GetXmlEnumFieldSummary(underlyingType, name!);
            <MudSelectItem T="T" Value="@enumValue">
                <MudTooltip Text="@tip" ShowOnHover="@( !string.IsNullOrWhiteSpace(tip) )">
                    <MudText>@name</MudText>
                </MudTooltip>
            </MudSelectItem>
        }
    </MudSelect>
}
else
{
    switch (typeCode)
    {
        case TypeCode.DateTime:
            <MudTextField T="T"
                Value="GetSafeDTValue()"
                ValueChanged="OnValueChanged"
                Format="s"
                InputType="InputType.DateTimeLocal"
                @attributes="mergedAttributes" />
            break;

        case TypeCode.Boolean:
            <MudSelect T="T"
                Value="@Value"
                ValueChanged="OnValueChanged"
                @attributes="mergedAttributes">
                <MudSelectItem T="T" Value="TypeExtensions.ChangeType<T>(true)">@LocalizedText.GetBoolLocalizedText(true)</MudSelectItem>
                <MudSelectItem T="T" Value="TypeExtensions.ChangeType<T>(false)">@LocalizedText.GetBoolLocalizedText(false)</MudSelectItem>
                @if (isNullable)
                {
                    <MudSelectItem T="T" Value="TypeExtensions.ChangeType<T>(null)">@LocalizedText.GetBoolLocalizedText(null)</MudSelectItem>
                }
            </MudSelect>
            break;

        case TypeCode.Single:
        case TypeCode.Double:
        case TypeCode.Decimal:
        case TypeCode.Int16:
        case TypeCode.Int32:
        case TypeCode.Int64:
        case TypeCode.UInt16:
        case TypeCode.UInt32:
        case TypeCode.UInt64:
            <MudNumericField T="T"
                Value="@Value"
                ValueChanged="OnValueChanged"
                Immediate="Immediate"
                @attributes="mergedAttributes" />
            break;

        default:
            <MudTextField T="T"
                Value="@Value"
                ValueChanged="OnValueChanged"
                InputType="GetInputTypeForText()"
                Immediate="Immediate"
                Clearable="Clearable"
                Typo="@Typo"
                @attributes="mergedAttributes" />
            break;
    }
}
