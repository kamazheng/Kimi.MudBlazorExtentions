@using Kimi.MudBlazorExtentions.Extensions
@using MudBlazor
@inherits MudBaseInput<object>

    @if (ClassInstance != null)
    {
    if (subPropertyInfos?.Any() == true)
    {
    <MudText Typo="Typo.subtitle1" Class="mt-5">@Label</MudText>
    foreach (var property in subPropertyInfos)
    {
    <DynamicInput ClassInstance="@classPropertyValue" PropertyInfo="@property" ClassInstanceChanged="e =>{
                                    classPropertyValue = e;
                                    ClassInstanceChanged.InvokeAsync(ClassInstance);
                                }" />
    }
    }
    else
    {
    var commonFieldAttributes = new Dictionary<string, object?>
        {
        { nameof(Label), Label },
        { nameof(HelperText), HelperText },
        { nameof(Disabled), Disabled },
        { nameof(ReadOnly), ReadOnly },
        { nameof(Required), Required },
        { nameof(Variant), Variant },
        { nameof(Margin), Margin },
        { nameof(Adornment), Adornment },
        { nameof(AdornmentIcon), AdornmentIcon },
        { nameof(FullWidth), FullWidth },
        { nameof(For), For },
        { nameof(Validation), Validation },
        { nameof(HelperTextOnFocus), HelperTextOnFocus },
        { nameof(Clearable), isNullable }
        };

        // 安全处理 AdditionalAttributes 可能为 null 的情况
        var safeAdditionalAttributes = UserAttributes ?? new Dictionary<string, object?>();

            var mergedAttributes = safeAdditionalAttributes
            .Concat(commonFieldAttributes.Where(kvp => !safeAdditionalAttributes.ContainsKey(kvp.Key)))
            .ToDictionary(kvp => kvp.Key, kvp => kvp.Value);

            @if (underlyingType == typeof(DateOnly))
            {
            DateTime? dateOfValue = Value is null? 
                    (isNullable?null:DateTime.Now):DateTime.Parse(Value.ToString()!);
            <MudDatePicker Date="@(dateOfValue)" DateChanged="(e) => {
                                    Value = e is null ? null: DateOnly.FromDateTime(e.Value);
                                    ClassInstance.SetPropertyValue(PropertyInfo.Name, Value);
                                    ClassInstanceChanged.InvokeAsync(ClassInstance);
                                }" @attributes="mergedAttributes" />
            }
            else if (underlyingType == typeof(TimeOnly))
            {
            DateTime? dateOfValue = Value is null? 
                                    (isNullable?null:DateTime.Now):DateTime.Parse(Value.ToString()!);
            <MudTimePicker Time="@(dateOfValue?.TimeOfDay)" TimeChanged="(e) => {
                                    Value = e;
                                    ClassInstance.SetPropertyValue(PropertyInfo.Name, Value);
                                    ClassInstanceChanged.InvokeAsync(ClassInstance);
                                }" @attributes="mergedAttributes" />
            }
            else if (underlyingType.IsEnum)
            {
            <MudSelect T="string" Value="@(Value?.ToString() ?? string.Empty)" ValueChanged="(e) => {
                                        Value = (object?)TypeExtensions.ChangeType<Enum>(Enum.Parse(underlyingType, e));
                                        ClassInstance.SetPropertyValue(PropertyInfo.Name, Value);
                                        ClassInstanceChanged.InvokeAsync(ClassInstance);
                                    }" @attributes="mergedAttributes">
                @foreach (var enumValue in Enum.GetValues(underlyingType))
                {
                var name = Enum.GetName(underlyingType, enumValue);
                var tip = Kimi.MudBlazorExtentions.Extensions
                .XmlDocExtensions.GetXmlEnumFieldSummary(underlyingType, name!);
                <MudSelectItem T="string" Value="@name">
                    <MudTooltip Text="@tip" ShowOnHover="@( !string.IsNullOrWhiteSpace(tip) )">
                        <MudText>@name</MudText>
                    </MudTooltip>
                </MudSelectItem>
                }
            </MudSelect>
            }
            else
            {
            switch (typeCode)
            {
            case TypeCode.DateTime:
            <MudTextField T="DateTime?" Format="s" InputType="InputType.DateTimeLocal" Value="@(DateTime.Parse(
                                (Value==null || Value?.ToString() == DateTime.MinValue.ToString() ? DateTime.Now.ToString():Value?.ToString())!
                            ))" ValueChanged="(e) => {
                            Value = TypeExtensions.ChangeType<DateTime?>(e);
                            ClassInstance.SetPropertyValue(PropertyInfo.Name, Value);
                            ClassInstanceChanged.InvokeAsync(ClassInstance);
                        }" @attributes="mergedAttributes" />
            break;
            case TypeCode.Boolean:
            <MudSelect T="bool?"
                Value="@(bool.TryParse(Value?.ToString(), out var boolValue) ? (bool?)boolValue : null)" ValueChanged="(e) => {
                                    Value = (object?)TypeExtensions.ChangeType<bool?>(e);
                                    ClassInstance.SetPropertyValue(PropertyInfo.Name, Value);
                                    ClassInstanceChanged.InvokeAsync(ClassInstance);
                            }" @attributes="mergedAttributes">
                <MudSelectItem T="bool?" Value="true">@LocalizedText.GetBoolLocalizedText(true)</MudSelectItem>
                <MudSelectItem T="bool?" Value="false">@LocalizedText.GetBoolLocalizedText(false)</MudSelectItem>
                @if (isNullable)
                {
                <MudSelectItem T="bool?" Value="null">@LocalizedText.GetBoolLocalizedText(null)</MudSelectItem>
                }
            </MudSelect>
            break;
            case TypeCode.Single:
            case TypeCode.Double:
            case TypeCode.Decimal:
            case TypeCode.Int16:
            case TypeCode.Int32:
            case TypeCode.Int64:
            case TypeCode.UInt16:
            case TypeCode.UInt32:
            case TypeCode.UInt64:
            <MudNumericField T="double?" Value="@(Value == null ? 
                                    (isNullable?null:0):double.Parse(Value.ToString()!))" ValueChanged="(e) => {
                                    Value = e;
                                    ClassInstance.SetPropertyValue(PropertyInfo.Name, Value);
                                    ClassInstanceChanged.InvokeAsync(ClassInstance);
                                }" @attributes="mergedAttributes"></MudNumericField>
            break;
            default:
            <MudTextField T="string" Value="@(Value==null? "":Value.ToString())" ValueChanged="(e) => {
                                    Value = e;
                                    ClassInstance.SetPropertyValue(PropertyInfo.Name, Value);
                                    ClassInstanceChanged.InvokeAsync(ClassInstance);
                                }" @attributes="mergedAttributes"></MudTextField>
            break;
            }
            }
            }
            }