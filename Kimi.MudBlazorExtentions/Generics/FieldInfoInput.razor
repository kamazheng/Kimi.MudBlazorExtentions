@using Kimi.MudBlazorExtentions.Extensions
@using MudBlazor
@inherits MudBaseInput<object>

@{
    var commonFieldAttributes = new Dictionary<string, object?>
    {
        { nameof(Label), Label },
        { nameof(HelperText), HelperText },
        { nameof(Disabled), Disabled },
        { nameof(ReadOnly), ReadOnly },
        { nameof(Required), Required },
        { nameof(Variant), Variant },
        { nameof(Margin), Margin },
        { nameof(Adornment), Adornment },
        { nameof(AdornmentIcon), AdornmentIcon },
        { nameof(FullWidth), FullWidth },
        { nameof(For), For },
        { nameof(Validation), Validation },
        { nameof(HelperTextOnFocus), HelperTextOnFocus },
        { nameof(Clearable), isNullable },
    };

    // 安全处理 mergedAttributes 可能为 null 的情况
    var safemergedAttributes = UserAttributes ?? new Dictionary<string, object?>();
    
    var mergedAttributes = safemergedAttributes
        .Concat(commonFieldAttributes.Where(kvp => !safemergedAttributes.ContainsKey(kvp.Key)))
        .ToDictionary(kvp => kvp.Key, kvp => kvp.Value);
}


@if (underlyingType == typeof(DateOnly))
{
    <MudDatePicker Date="@(DateTime.Parse(Value?.ToString() ?? DateTime.Now.ToString()))"
                   DateChanged="(e) => {
                                    Value =(object)TypeExtensions.ChangeType<DateTime>(DateOnly.FromDateTime((DateTime)e!));
                                    FieldInfo.SetValue(TupleInstance, Value);
                                    TupleInstanceChanged.InvokeAsync(TupleInstance);
                                }"
                   @attributes="@mergedAttributes" />
}
else if (underlyingType == typeof(TimeOnly))
{
    <MudTimePicker Time="@(DateTime.Parse(Value?.ToString() ?? DateTime.Now.ToString()).TimeOfDay)"
                   TimeChanged="(e) => {
                                    Value = (object)TypeExtensions.ChangeType<DateTime>(TimeOnly.FromTimeSpan((TimeSpan)e!));
                                    FieldInfo.SetValue(TupleInstance, Value);
                                    TupleInstanceChanged.InvokeAsync(TupleInstance);
                                }"
                   @attributes="@mergedAttributes" />
}
else
{
    switch (TypeCode)
    {
        case TypeCode.DateTime:
            <MudGrid>
                <MudItem xs="12" sm="6">
                    <MudDatePicker Date="@(DateTime.Parse(Value?.ToString() ?? DateTime.Now.ToString()))"
                                   DateChanged="(e) => {
                                        var date = e ?? DateTime.Now;
                                        var time = DateTime.Parse(Value?.ToString() ?? DateTime.Now.ToString()).TimeOfDay;
                                        Value =(object)TypeExtensions.ChangeType<DateTime>(date.Date + time);
                                        FieldInfo.SetValue(TupleInstance, Value);
                                        TupleInstanceChanged.InvokeAsync(TupleInstance);
                                        }"
                                   @attributes="@mergedAttributes" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTimePicker Time="@(DateTime.Parse(Value?.ToString() ?? DateTime.Now.ToString()).TimeOfDay)"
                                   TimeChanged="(e) => {
                                        var time = e ?? TimeSpan.Zero;
                                        var date = DateTime.Parse(Value?.ToString() ?? DateTime.Now.ToString()).Date;
                                        Value = (object)TypeExtensions.ChangeType<DateTime>(date + time);
                                        FieldInfo.SetValue(TupleInstance, Value);
                                        TupleInstanceChanged.InvokeAsync(TupleInstance);
                                   }"
                                   @attributes="@mergedAttributes" />
                </MudItem>
            </MudGrid>
            break;
        case TypeCode.Boolean:
            <MudCheckBox T="bool?"
                         Label="@Label"
                         LabelPosition="LabelPosition.End"
                         Value="@((bool?)Value)"
                         ValueChanged="(e) => {
                                        Value = (object)TypeExtensions.ChangeType<bool>(e ?? false);
                                        FieldInfo.SetValue(TupleInstance, Value);
                                        TupleInstanceChanged.InvokeAsync(TupleInstance);
                                   }"
                         @attributes="@mergedAttributes"></MudCheckBox>
            break;
        case TypeCode.Single:
        case TypeCode.Double:
        case TypeCode.Decimal:
        case TypeCode.Int16:
        case TypeCode.Int32:
        case TypeCode.Int64:
            <MudNumericField T="double?"
                             Value="@(ToDoubleOrDefault(Value))"
                             ValueChanged="(e) => {
                                    var targetType = Nullable.GetUnderlyingType(FieldInfo.FieldType) ?? FieldInfo.FieldType;
                                    Value =TypeExtensions.ChangeType(e, targetType);
                                    FieldInfo.SetValue(TupleInstance, Value);
                                    TupleInstanceChanged.InvokeAsync(TupleInstance);
                                }"
                             @attributes="@mergedAttributes"></MudNumericField>
            break;
        default:
            <MudTextField T="string" Value="@(Value==null? "":Value.ToString())"
                          ValueChanged="(e) => {
                                    Value = e;
                                    FieldInfo.SetValue(TupleInstance, Value);
                                    TupleInstanceChanged.InvokeAsync(TupleInstance);
                                }"
                          @attributes="@mergedAttributes"></MudTextField>
            break;
    }
}
